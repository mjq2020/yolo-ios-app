// Ultralytics ğŸš€ AGPL-3.0 License - https://ultralytics.com/license

//  ========================================
//  ğŸ“± AppDelegate.swift - åº”ç”¨ç¨‹åºå…¥å£æ–‡ä»¶
//  ========================================
//
//  è¿™æ˜¯ iOS åº”ç”¨çš„ã€ç¨‹åºå…¥å£ã€‘ï¼Œæ˜¯åº”ç”¨å¯åŠ¨æ—¶ç¬¬ä¸€ä¸ªè¢«è°ƒç”¨çš„æ–‡ä»¶
//  
//  ğŸ”‘ å…³é”®æ¦‚å¿µï¼š
//  - AppDelegate æ˜¯åº”ç”¨ç¨‹åºçš„"ä»£ç†"ï¼Œè´Ÿè´£å¤„ç†åº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶
//  - @UIApplicationMain æ ‡è®°è¡¨ç¤ºè¿™æ˜¯åº”ç”¨ç¨‹åºçš„å…¥å£ç‚¹
//  - å½“ç”¨æˆ·ç‚¹å‡» App å›¾æ ‡æ—¶ï¼Œç³»ç»Ÿä¼šåˆ›å»º AppDelegate å®ä¾‹å¹¶è°ƒç”¨å…¶æ–¹æ³•
//
//  ğŸ“š å­¦ä¹ è¦ç‚¹ï¼š
//  1. iOS åº”ç”¨å¯åŠ¨æµç¨‹ï¼šç³»ç»Ÿ â†’ AppDelegate â†’ çª—å£ â†’ è§†å›¾æ§åˆ¶å™¨
//  2. UserDefaultsï¼šç”¨äºå­˜å‚¨ç®€å•çš„é”®å€¼å¯¹æ•°æ®ï¼ˆç±»ä¼¼äºæµè§ˆå™¨çš„ localStorageï¼‰
//  3. UIDeviceï¼šè·å–è®¾å¤‡ä¿¡æ¯çš„ç³»ç»Ÿç±»
//

import UIKit

/// ä¸»åº”ç”¨ç¨‹åºä»£ç†ç±»ï¼Œå¤„ç†å…¨å±€åº”ç”¨è¡Œä¸ºå’Œé…ç½®
/// 
/// ğŸ“Œ ç»§æ‰¿å…³ç³»ï¼š
/// - UIResponder: å“åº”å’Œå¤„ç†äº‹ä»¶çš„åŸºç±»
/// - UIApplicationDelegate: å®šä¹‰åº”ç”¨ç”Ÿå‘½å‘¨æœŸæ–¹æ³•çš„åè®®
///
/// ğŸ“Œ @UIApplicationMain è¯´æ˜ï¼š
/// - è¿™ä¸ªæ³¨è§£å‘Šè¯‰ç¼–è¯‘å™¨ï¼šè¿™æ˜¯åº”ç”¨çš„å…¥å£ç±»
/// - ç­‰åŒäºåœ¨ main.swift ä¸­è°ƒç”¨ UIApplicationMain() å‡½æ•°
@UIApplicationMain
class AppDelegate: UIResponder, UIApplicationDelegate {
  
  /// åº”ç”¨çš„ä¸»çª—å£
  /// ğŸ“Œ window æ˜¯åº”ç”¨ç•Œé¢çš„æ ¹å®¹å™¨ï¼Œæ‰€æœ‰ UI å…ƒç´ éƒ½æ˜¾ç¤ºåœ¨è¿™ä¸ªçª—å£å†…
  var window: UIWindow?

  /// ğŸš€ ã€æœ€é‡è¦çš„æ–¹æ³•ã€‘åº”ç”¨å¯åŠ¨å®Œæˆæ—¶è°ƒç”¨
  ///
  /// è¿™ä¸ªæ–¹æ³•åœ¨åº”ç”¨å®Œæˆå¯åŠ¨åè¢«ç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨ï¼Œæ˜¯è¿›è¡Œåˆå§‹åŒ–é…ç½®çš„æœ€ä½³ä½ç½®
  /// 
  /// - Parameters:
  ///   - application: å½“å‰åº”ç”¨å®ä¾‹
  ///   - launchOptions: å¯åŠ¨é€‰é¡¹å­—å…¸ï¼ŒåŒ…å«åº”ç”¨æ˜¯å¦‚ä½•å¯åŠ¨çš„ä¿¡æ¯ï¼ˆå¦‚é€šè¿‡æ¨é€é€šçŸ¥ç­‰ï¼‰
  /// - Returns: è¿”å› true è¡¨ç¤ºåº”ç”¨æˆåŠŸå¯åŠ¨
  func application(
    _ application: UIApplication,
    didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?
  ) -> Bool {
    
    // ============================================
    // 1ï¸âƒ£ ç¦ç”¨å±å¹•è‡ªåŠ¨é”å®š
    // ============================================
    // ğŸ“Œ ä½œç”¨ï¼šé˜²æ­¢å±å¹•åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å˜æš—æˆ–è‡ªåŠ¨é”å®š
    // ğŸ“Œ åœºæ™¯ï¼šYOLO å®æ—¶æ£€æµ‹éœ€è¦æŒç»­æ˜¾ç¤ºç›¸æœºç”»é¢ï¼Œä¸å¸Œæœ›å±å¹•è‡ªåŠ¨å…³é—­
    UIApplication.shared.isIdleTimerDisabled = true

    // ============================================
    // 2ï¸âƒ£ å¯ç”¨ç”µæ± ç›‘æ§
    // ============================================
    // ğŸ“Œ ä½œç”¨ï¼šå…è®¸åº”ç”¨è·å–ç”µæ± ç”µé‡å’Œå……ç”µçŠ¶æ€
    // ğŸ“Œ åœºæ™¯ï¼šå¯ä»¥æ ¹æ®ç”µæ± ç”µé‡è°ƒæ•´åº”ç”¨è¡Œä¸ºï¼ˆå¦‚ä½ç”µé‡æ—¶é™ä½æ¨ç†é¢‘ç‡ï¼‰
    UIDevice.current.isBatteryMonitoringEnabled = true

    // ============================================
    // 3ï¸âƒ£ å­˜å‚¨åº”ç”¨ç‰ˆæœ¬ä¿¡æ¯åˆ° UserDefaults
    // ============================================
    // ğŸ“Œ Bundle.main.infoDictionary: åŒ…å« Info.plist ä¸­çš„æ‰€æœ‰é…ç½®ä¿¡æ¯
    // ğŸ“Œ CFBundleShortVersionString: ç‰ˆæœ¬å·ï¼ˆå¦‚ "1.0.0"ï¼‰
    // ğŸ“Œ CFBundleVersion: æ„å»ºå·ï¼ˆå¦‚ "100"ï¼‰
    if let appVersion = Bundle.main.infoDictionary?["CFBundleShortVersionString"] as? String,
      let buildVersion = Bundle.main.infoDictionary?["CFBundleVersion"] as? String
    {
      // å°†ç‰ˆæœ¬ä¿¡æ¯å­˜å‚¨ä¸º "1.0.0 (100)" æ ¼å¼
      UserDefaults.standard.set("\(appVersion) (\(buildVersion))", forKey: "app_version")
    }

    // ============================================
    // 4ï¸âƒ£ å­˜å‚¨è®¾å¤‡ UUID åˆ° UserDefaults
    // ============================================
    // ğŸ“Œ UUID: è®¾å¤‡çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºè¯†åˆ«ä¸åŒè®¾å¤‡
    // ğŸ“Œ æ³¨æ„ï¼šè¿™ä¸ª UUID åœ¨åº”ç”¨é‡æ–°å®‰è£…åä¼šæ”¹å˜
    if let uuid = UIDevice.current.identifierForVendor?.uuidString {
      UserDefaults.standard.set(uuid, forKey: "uuid")
    }

    // ============================================
    // 5ï¸âƒ£ å¼ºåˆ¶åŒæ­¥ UserDefaults
    // ============================================
    // ğŸ“Œ ä½œç”¨ï¼šç¡®ä¿ä¸Šé¢è®¾ç½®çš„å€¼ç«‹å³å†™å…¥ç£ç›˜
    // ğŸ“Œ é€šå¸¸ UserDefaults ä¼šè‡ªåŠ¨åŒæ­¥ï¼Œä½†åœ¨å¯åŠ¨æ—¶æ˜¾å¼è°ƒç”¨æ›´å®‰å…¨
    UserDefaults.standard.synchronize()

    // è¿”å› true è¡¨ç¤ºåº”ç”¨å¯åŠ¨æˆåŠŸ
    return true
  }
}

// ============================================
// ğŸ“¸ CALayer æ‰©å±• - æˆªå›¾åŠŸèƒ½
// ============================================
/// ä¸º CALayer æ·»åŠ æˆªå›¾èƒ½åŠ›çš„æ‰©å±•
/// 
/// ğŸ“Œ æ‰©å±•ï¼ˆExtensionï¼‰è¯´æ˜ï¼š
/// - Swift çš„æ‰©å±•å¯ä»¥ä¸ºå·²æœ‰çš„ç±»ã€ç»“æ„ä½“æ·»åŠ æ–°åŠŸèƒ½
/// - è¿™é‡Œä¸º CALayerï¼ˆå›¾å±‚ç±»ï¼‰æ·»åŠ äº†æˆªå›¾å±æ€§
extension CALayer {
  
  /// è®¡ç®—å±æ€§ï¼šè·å–å½“å‰å›¾å±‚çš„æˆªå›¾
  /// 
  /// ğŸ“Œ ä½¿ç”¨åœºæ™¯ï¼šç”¨æˆ·ç‚¹å‡»åˆ†äº«æŒ‰é’®æ—¶ï¼Œæˆªå–å½“å‰æ£€æµ‹ç»“æœç”»é¢
  /// 
  /// ğŸ“Œ å®ç°åŸç†ï¼š
  /// 1. åˆ›å»ºä¸€ä¸ªå›¾å½¢ä¸Šä¸‹æ–‡ï¼ˆç”»å¸ƒï¼‰
  /// 2. å°†å›¾å±‚å†…å®¹æ¸²æŸ“åˆ°ç”»å¸ƒä¸Š
  /// 3. ä»ç”»å¸ƒä¸­æå–å›¾ç‰‡
  var screenShot: UIImage? {
    // å¼€å§‹ä¸€ä¸ªæ–°çš„å›¾åƒä¸Šä¸‹æ–‡
    // ğŸ“Œ å‚æ•°è¯´æ˜ï¼š
    // - frame.size: å›¾ç‰‡å°ºå¯¸ï¼Œä¸å›¾å±‚å¤§å°ç›¸åŒ
    // - false: æ˜¯å¦ä¸é€æ˜ï¼ˆfalse è¡¨ç¤ºæ”¯æŒé€æ˜åº¦ï¼‰
    // - UIScreen.main.scale: å±å¹•ç¼©æ”¾å› å­ï¼ˆç¡®ä¿ Retina å±å¹•çš„æ¸…æ™°åº¦ï¼‰
    UIGraphicsBeginImageContextWithOptions(frame.size, false, UIScreen.main.scale)
    
    // defer å…³é”®å­—ï¼šç¡®ä¿æ— è®ºå‡½æ•°å¦‚ä½•é€€å‡ºï¼Œéƒ½ä¼šæ‰§è¡Œæ¸…ç†æ“ä½œ
    // ğŸ“Œ è¿™é‡Œç¡®ä¿å›¾å½¢ä¸Šä¸‹æ–‡è¢«æ­£ç¡®å…³é—­ï¼Œé¿å…å†…å­˜æ³„æ¼
    defer {
      UIGraphicsEndImageContext()
    }
    
    // è·å–å½“å‰å›¾å½¢ä¸Šä¸‹æ–‡å¹¶æ¸²æŸ“å›¾å±‚
    if let context = UIGraphicsGetCurrentContext() {
      // å°†å›¾å±‚å†…å®¹ç»˜åˆ¶åˆ°å½“å‰ä¸Šä¸‹æ–‡
      render(in: context)
      // ä»ä¸Šä¸‹æ–‡ä¸­æå–å›¾ç‰‡å¹¶è¿”å›
      return UIGraphicsGetImageFromCurrentImageContext()
    }
    
    // å¦‚æœæ“ä½œå¤±è´¥ï¼Œè¿”å› nil
    return nil
  }
}
